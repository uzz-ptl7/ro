<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gas Store Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6 font-sans">
    <h1 class="text-3xl font-bold mb-6 text-center">Gas Store Management</h1>

    <div class="max-w-6xl mx-auto space-y-10">

        <!-- Stock Management -->
        <section class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-semibold mb-4">Stock Management</h2>
            <form id="stock-management-form" class="flex flex-wrap gap-4 items-end">
                <div>
                    <label for="stock-product" class="block font-medium mb-1">Product</label>
                    <input list="product-list" id="stock-product" name="stock-product" required
                        class="border border-gray-300 rounded p-2 w-48" />
                    <datalist id="product-list"></datalist>
                </div>
                <div>
                    <label for="add-stock-quantity" class="block font-medium mb-1">Add Quantity</label>
                    <input type="number" id="add-stock-quantity" name="add-stock-quantity" min="1" required
                        class="border border-gray-300 rounded p-2 w-28" />
                </div>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add
                    Stock</button>
            </form>
            <div class="mt-6">
                <h3 class="font-semibold mb-2">Current Stock Summary</h3>
                <table class="w-full border border-gray-300 rounded overflow-hidden">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="border border-gray-300 px-3 py-1 text-left">Product</th>
                            <th class="border border-gray-300 px-3 py-1 text-right">Starting Inventory</th>
                            <th class="border border-gray-300 px-3 py-1 text-right">Added Stock</th>
                            <th class="border border-gray-300 px-3 py-1 text-right">Sold Cylinders</th>
                            <th class="border border-gray-300 px-3 py-1 text-right">Current Stock</th>
                        </tr>
                    </thead>
                    <tbody id="stock-summary-body"></tbody>
                </table>
            </div>
        </section>

        <!-- Record Sale -->
        <section class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-semibold mb-4">Record Sale</h2>
            <form id="sales-form" class="flex flex-wrap gap-4 items-end">
                <div>
                    <label for="product" class="block font-medium mb-1">Product</label>
                    <input list="product-list" id="product" name="product" required
                        class="border border-gray-300 rounded p-2 w-48" autocomplete="off" />
                </div>
                <div>
                    <label for="quantity" class="block font-medium mb-1">Quantity</label>
                    <input type="number" id="quantity" name="quantity" min="1" required
                        class="border border-gray-300 rounded p-2 w-28" />
                </div>
                <div>
                    <label for="discount" class="block font-medium mb-1">Discount (%)</label>
                    <input type="number" id="discount" name="discount" min="0" max="100" value="0"
                        class="border border-gray-300 rounded p-2 w-28" />
                </div>
                <div>
                    <label for="payment-method" class="block font-medium mb-1">Payment Method</label>
                    <select id="payment-method" name="payment-method" required
                        class="border border-gray-300 rounded p-2 w-36">
                        <option value="">Select</option>
                        <option value="cash">Cash</option>
                        <option value="momo">Momo Pay</option>
                    </select>
                </div>
                <div id="momo-id-field" class="hidden">
                    <label for="momo-id" class="block font-medium mb-1">Momo Pay ID</label>
                    <input type="text" id="momo-id" name="momo-id" class="border border-gray-300 rounded p-2 w-48"
                        autocomplete="off" />
                </div>
                <div>
                    <label for="customer" class="block font-medium mb-1">Customer</label>
                    <input list="customer-list" id="customer" name="customer" required
                        class="border border-gray-300 rounded p-2 w-48" autocomplete="off" />
                    <datalist id="customer-list"></datalist>
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Record
                    Sale</button>
            </form>
        </section>

        <!-- Sales Ledgers -->
        <section class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-semibold mb-4">Sales Ledgers</h2>

            <div class="mb-4">
                <h3 class="font-semibold mb-2">Cash Ledger</h3>
                <table class="w-full border border-gray-300 rounded overflow-hidden text-sm">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="border border-gray-300 px-2 py-1">Date</th>
                            <th class="border border-gray-300 px-2 py-1">Product</th>
                            <th class="border border-gray-300 px-2 py-1 text-right">Qty</th>
                            <th class="border border-gray-300 px-2 py-1 text-right">Discount %</th>
                            <th class="border border-gray-300 px-2 py-1 text-right">Amount (RWF)</th>
                            <th class="border border-gray-300 px-2 py-1">Customer</th>
                            <th class="border border-gray-300 px-2 py-1">Payment Method</th>
                            <th class="border border-gray-300 px-2 py-1">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cash-ledger-body"></tbody>
                </table>
            </div>

            <div>
                <h3 class="font-semibold mb-2">Momo Pay Ledger</h3>
                <table class="w-full border border-gray-300 rounded overflow-hidden text-sm">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="border border-gray-300 px-2 py-1">Date</th>
                            <th class="border border-gray-300 px-2 py-1">Product</th>
                            <th class="border border-gray-300 px-2 py-1 text-right">Qty</th>
                            <th class="border border-gray-300 px-2 py-1 text-right">Discount %</th>
                            <th class="border border-gray-300 px-2 py-1 text-right">Amount (RWF)</th>
                            <th class="border border-gray-300 px-2 py-1">Customer</th>
                            <th class="border border-gray-300 px-2 py-1">Momo ID</th>
                            <th class="border border-gray-300 px-2 py-1">Payment Method</th>
                            <th class="border border-gray-300 px-2 py-1">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="momo-ledger-body"></tbody>
                </table>
            </div>
        </section>

    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded p-6 w-full max-w-lg relative">
            <h2 class="text-xl font-semibold mb-4">Edit Transaction</h2>
            <form id="edit-form" class="space-y-4">
                <div>
                    <label for="edit-product" class="block font-medium mb-1">Product</label>
                    <input list="product-list" id="edit-product" name="edit-product" required
                        class="border border-gray-300 rounded p-2 w-full" autocomplete="off" />
                </div>
                <div>
                    <label for="edit-quantity" class="block font-medium mb-1">Quantity</label>
                    <input type="number" id="edit-quantity" name="edit-quantity" min="1" required
                        class="border border-gray-300 rounded p-2 w-full" />
                </div>
                <div>
                    <label for="edit-discount" class="block font-medium mb-1">Discount (%)</label>
                    <input type="number" id="edit-discount" name="edit-discount" min="0" max="100" value="0"
                        class="border border-gray-300 rounded p-2 w-full" />
                </div>
                <div>
                    <label for="edit-payment-method" class="block font-medium mb-1">Payment Method</label>
                    <select id="edit-payment-method" name="edit-payment-method" required
                        class="border border-gray-300 rounded p-2 w-full">
                        <option value="">Select</option>
                        <option value="cash">Cash</option>
                        <option value="momo">Momo Pay</option>
                    </select>
                </div>
                <div id="edit-momo-id-field" class="hidden">
                    <label for="edit-momo-id" class="block font-medium mb-1">Momo Pay ID</label>
                    <input type="text" id="edit-momo-id" name="edit-momo-id"
                        class="border border-gray-300 rounded p-2 w-full" autocomplete="off" />
                </div>
                <div>
                    <label for="edit-customer" class="block font-medium mb-1">Customer</label>
                    <input list="customer-list" id="edit-customer" name="edit-customer" required
                        class="border border-gray-300 rounded p-2 w-full" autocomplete="off" />
                </div>
                <div>
                    <label for="edit-date" class="block font-medium mb-1">Date & Time</label>
                    <input type="datetime-local" id="edit-date" name="edit-date" required
                        class="border border-gray-300 rounded p-2 w-full" />
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" id="close-edit-modal"
                        class="px-4 py-2 rounded bg-gray-400 hover:bg-gray-500 text-white">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data structures
        let products = [];
        let customers = [];
        let cashLedger = [];
        let momoLedger = [];

        // Default products to seed if none in storage
        const defaultProducts = [
            { name: "Gas Cylinder 6kg", unitPrice: 12000, startingInventory: 50, addedStock: 0 },
            { name: "Gas Cylinder 12kg", unitPrice: 22000, startingInventory: 30, addedStock: 0 },
            { name: "Gas Cylinder 24kg", unitPrice: 38000, startingInventory: 20, addedStock: 0 }
        ];

        // LocalStorage keys
        const STORAGE_KEYS = {
            PRODUCTS: 'gsm_products',
            CUSTOMERS: 'gsm_customers',
            CASH_LEDGER: 'gsm_cashLedger',
            MOMO_LEDGER: 'gsm_momoLedger'
        };

        // Utility: format number as RWF currency
        function formatRWF(amount) {
            return "RWF " + amount.toLocaleString('en-US', { minimumFractionDigits: 0 });
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            localStorage.setItem(STORAGE_KEYS.CUSTOMERS, JSON.stringify(customers));
            localStorage.setItem(STORAGE_KEYS.CASH_LEDGER, JSON.stringify(cashLedger));
            localStorage.setItem(STORAGE_KEYS.MOMO_LEDGER, JSON.stringify(momoLedger));
        }

        // Load data from localStorage or seed defaults
        function loadData() {
            products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || JSON.parse(JSON.stringify(defaultProducts));
            customers = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOMERS)) || [];
            cashLedger = JSON.parse(localStorage.getItem(STORAGE_KEYS.CASH_LEDGER)) || [];
            momoLedger = JSON.parse(localStorage.getItem(STORAGE_KEYS.MOMO_LEDGER)) || [];
        }

        // Calculate total sold cylinders of a product (sum quantity from both ledgers)
        function totalSold(productName) {
            let soldCash = cashLedger.filter(t => t.product === productName)
                .reduce((sum, t) => sum + t.quantity, 0);
            let soldMomo = momoLedger.filter(t => t.product === productName)
                .reduce((sum, t) => sum + t.quantity, 0);
            return soldCash + soldMomo;
        }

        // Calculate current stock of product (starting + added - sold)
        function currentStock(productName) {
            let product = products.find(p => p.name === productName);
            if (!product) return 0;
            return product.startingInventory + product.addedStock - totalSold(productName);
        }

        // Load product datalist options
        function loadProductList() {
            const productList = document.getElementById('product-list');
            productList.innerHTML = '';
            products.forEach(p => {
                let option = document.createElement('option');
                option.value = p.name;
                productList.appendChild(option);
            });
        }

        // Load customer datalist options
        function loadCustomerList() {
            const customerList = document.getElementById('customer-list');
            customerList.innerHTML = '';
            customers.forEach(c => {
                let option = document.createElement('option');
                option.value = c.name;
                customerList.appendChild(option);
            });
        }

        // Update current stock summary table
        function updateStockSummary() {
            const tbody = document.getElementById('stock-summary-body');
            tbody.innerHTML = '';
            products.forEach(p => {
                let tr = document.createElement('tr');
                tr.classList.add('even:bg-gray-50');
                tr.innerHTML = `
        <td class="border border-gray-300 px-3 py-1">${p.name}</td>
        <td class="border border-gray-300 px-3 py-1 text-right">${p.startingInventory}</td>
        <td class="border border-gray-300 px-3 py-1 text-right">${p.addedStock}</td>
        <td class="border border-gray-300 px-3 py-1 text-right">${totalSold(p.name)}</td>
        <td class="border border-gray-300 px-3 py-1 text-right font-semibold">${currentStock(p.name)}</td>
      `;
                tbody.appendChild(tr);
            });
        }

        // Render ledger rows for a given ledger array & table body element
        function renderLedger(ledger, tbodyId, isMomo = false) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            ledger.forEach(t => {
                const date = new Date(t.date);
                let dateStr = date.toLocaleString('en-GB', { hour12: false });
                tbody.innerHTML += `
        <tr class="even:bg-gray-50" data-id="${t.id}" data-ledger="${isMomo ? 'momo' : 'cash'}">
          <td class="border border-gray-300 px-2 py-1">${dateStr}</td>
          <td class="border border-gray-300 px-2 py-1">${t.product}</td>
          <td class="border border-gray-300 px-2 py-1 text-right">${t.quantity}</td>
          <td class="border border-gray-300 px-2 py-1 text-right">${t.discount.toFixed(1)}</td>
          <td class="border border-gray-300 px-2 py-1 text-right">${formatRWF(Math.round(t.amount))}</td>
          <td class="border border-gray-300 px-2 py-1">${t.customer}</td>
          ${isMomo ? `<td class="border border-gray-300 px-2 py-1">${t.momoId || ''}</td>` : ''}
          <td class="border border-gray-300 px-2 py-1 capitalize">${t.paymentMethod}</td>
          <td class="border border-gray-300 px-2 py-1 space-x-2 text-center">
            <button class="edit-btn text-blue-600 hover:underline text-sm">Edit</button>
            <button class="delete-btn text-red-600 hover:underline text-sm">Delete</button>
          </td>
        </tr>
      `;
            });
        }

        // Generate unique ID
        function generateId() {
            return 'id-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }

        // Save a new sale transaction
        function addSaleTransaction(data) {
            // Validate product exists
            const product = products.find(p => p.name === data.product);
            if (!product) {
                alert("Product not found in stock. Please add it first.");
                return false;
            }

            // Validate stock availability
            const available = currentStock(data.product);
            if (data.quantity > available) {
                alert(`Insufficient stock for ${data.product}. Available: ${available}`);
                return false;
            }

            // Calculate amount after discount
            const totalPrice = product.unitPrice * data.quantity;
            const discountedPrice = totalPrice * (1 - data.discount / 100);

            // Add customer if new
            if (!customers.some(c => c.name.toLowerCase() === data.customer.toLowerCase())) {
                customers.push({ name: data.customer });
            }

            // Create transaction object
            const transaction = {
                id: generateId(),
                date: new Date().toISOString(),
                product: data.product,
                quantity: data.quantity,
                discount: data.discount,
                amount: discountedPrice,
                customer: data.customer,
                paymentMethod: data.paymentMethod,
                momoId: data.paymentMethod === 'momo' ? data.momoId : null
            };

            // Add to correct ledger
            if (data.paymentMethod === 'cash') {
                cashLedger.push(transaction);
            } else {
                momoLedger.push(transaction);
            }

            saveData();
            updateAll();
            return true;
        }

        // Update all UI parts (stock summary, ledgers, datalists)
        function updateAll() {
            loadProductList();
            loadCustomerList();
            updateStockSummary();
            renderLedger(cashLedger, 'cash-ledger-body', false);
            renderLedger(momoLedger, 'momo-ledger-body', true);
        }

        // Delete transaction from ledger
        function deleteTransaction(id, ledgerType) {
            if (!confirm("Are you sure you want to delete this transaction?")) return;
            if (ledgerType === 'cash') {
                cashLedger = cashLedger.filter(t => t.id !== id);
            } else {
                momoLedger = momoLedger.filter(t => t.id !== id);
            }
            saveData();
            updateAll();
        }

        // Edit transaction modal management
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        let currentEditId = null;
        let currentEditLedger = null;

        function openEditModal(id, ledgerType) {
            currentEditId = id;
            currentEditLedger = ledgerType;
            const ledgerArray = ledgerType === 'cash' ? cashLedger : momoLedger;
            const transaction = ledgerArray.find(t => t.id === id);
            if (!transaction) {
                alert("Transaction not found.");
                return;
            }
            // Populate form fields
            editForm['edit-product'].value = transaction.product;
            editForm['edit-quantity'].value = transaction.quantity;
            editForm['edit-discount'].value = transaction.discount;
            editForm['edit-payment-method'].value = transaction.paymentMethod;
            editForm['edit-customer'].value = transaction.customer;
            editForm['edit-date'].value = transaction.date.substring(0, 16);
            editForm['edit-momo-id'].value = transaction.momoId || '';

            toggleEditMomoField(transaction.paymentMethod);

            editModal.classList.remove('hidden');
        }

        function toggleMomoField() {
            const paymentMethod = document.getElementById('payment-method').value;
            const momoField = document.getElementById('momo-id-field');
            if (paymentMethod === 'momo') {
                momoField.classList.remove('hidden');
                document.getElementById('momo-id').setAttribute('required', 'required');
            } else {
                momoField.classList.add('hidden');
                document.getElementById('momo-id').removeAttribute('required');
                document.getElementById('momo-id').value = '';
            }
        }

        function toggleEditMomoField(paymentMethod) {
            const momoField = document.getElementById('edit-momo-id-field');
            const momoInput = document.getElementById('edit-momo-id');
            if (paymentMethod === 'momo') {
                momoField.classList.remove('hidden');
                momoInput.setAttribute('required', 'required');
            } else {
                momoField.classList.add('hidden');
                momoInput.removeAttribute('required');
                momoInput.value = '';
            }
        }

        // Event Listeners

        // Toggle momo ID input on payment method change (record sale form)
        document.getElementById('payment-method').addEventListener('change', toggleMomoField);

        // Toggle momo ID input on payment method change (edit form)
        document.getElementById('edit-payment-method').addEventListener('change', (e) => {
            toggleEditMomoField(e.target.value);
        });

        // Handle stock management form submit (add stock)
        document.getElementById('stock-management-form').addEventListener('submit', e => {
            e.preventDefault();
            const productName = e.target['stock-product'].value.trim();
            const qty = parseInt(e.target['add-stock-quantity'].value);

            if (!productName) return alert("Please enter/select a product.");
            if (qty <= 0) return alert("Quantity must be at least 1.");

            // Find product or create new
            let product = products.find(p => p.name.toLowerCase() === productName.toLowerCase());
            if (!product) {
                // Add new product with zero startingInventory and addedStock = qty
                product = { name: productName, unitPrice: 0, startingInventory: 0, addedStock: 0 };
                products.push(product);
                alert(`New product added. Please update unit price in code if needed.`);
            }
            product.addedStock += qty;

            saveData();
            updateAll();
            e.target.reset();
        });

        // Handle record sale form submit
        document.getElementById('sales-form').addEventListener('submit', e => {
            e.preventDefault();
            const data = {
                product: e.target['product'].value.trim(),
                quantity: parseInt(e.target['quantity'].value),
                discount: parseFloat(e.target['discount'].value) || 0,
                paymentMethod: e.target['payment-method'].value,
                momoId: e.target['momo-id'].value.trim(),
                customer: e.target['customer'].value.trim()
            };

            if (!data.product || !data.customer || !data.paymentMethod) {
                alert("Please fill in all required fields.");
                return;
            }
            if (data.paymentMethod === 'momo' && !data.momoId) {
                alert("Please enter Momo Pay ID.");
                return;
            }
            if (data.quantity < 1) {
                alert("Quantity must be at least 1.");
                return;
            }
            if (data.discount < 0 || data.discount > 100) {
                alert("Discount must be between 0 and 100.");
                return;
            }

            if (addSaleTransaction(data)) {
                alert("Sale recorded successfully.");
                e.target.reset();
                toggleMomoField();
            }
        });

        // Delegate ledger buttons (edit/delete)
        document.addEventListener('click', e => {
            if (e.target.classList.contains('delete-btn')) {
                const tr = e.target.closest('tr');
                const id = tr.dataset.id;
                const ledgerType = tr.dataset.ledger;
                deleteTransaction(id, ledgerType);
            }
            if (e.target.classList.contains('edit-btn')) {
                const tr = e.target.closest('tr');
                const id = tr.dataset.id;
                const ledgerType = tr.dataset.ledger;
                openEditModal(id, ledgerType);
            }
        });

        // Close edit modal
        document.getElementById('close-edit-modal').addEventListener('click', () => {
            editModal.classList.add('hidden');
            editForm.reset();
            currentEditId = null;
            currentEditLedger = null;
        });

        // Handle edit form submit
        editForm.addEventListener('submit', e => {
            e.preventDefault();
            if (!currentEditId || !currentEditLedger) {
                alert("No transaction selected.");
                return;
            }
            const ledgerArray = currentEditLedger === 'cash' ? cashLedger : momoLedger;
            const idx = ledgerArray.findIndex(t => t.id === currentEditId);
            if (idx === -1) {
                alert("Transaction not found.");
                return;
            }

            const productName = editForm['edit-product'].value.trim();
            const quantity = parseInt(editForm['edit-quantity'].value);
            const discount = parseFloat(editForm['edit-discount'].value) || 0;
            const paymentMethod = editForm['edit-payment-method'].value;
            const momoId = editForm['edit-momo-id'].value.trim();
            const customer = editForm['edit-customer'].value.trim();
            const date = editForm['edit-date'].value;

            if (!productName || !customer || !paymentMethod) {
                alert("Please fill in all required fields.");
                return;
            }
            if (paymentMethod === 'momo' && !momoId) {
                alert("Please enter Momo Pay ID.");
                return;
            }
            if (quantity < 1) {
                alert("Quantity must be at least 1.");
                return;
            }
            if (discount < 0 || discount > 100) {
                alert("Discount must be between 0 and 100.");
                return;
            }

            // Validate product exists
            const product = products.find(p => p.name === productName);
            if (!product) {
                alert("Product not found in stock.");
                return;
            }

            // Validate stock availability, considering current transaction quantity removed from stock calculation
            const stockAvailable = currentStock(productName) + ledgerArray[idx].quantity;
            if (quantity > stockAvailable) {
                alert(`Insufficient stock for ${productName}. Available: ${stockAvailable}`);
                return;
            }

            // Update transaction
            const totalPrice = product.unitPrice * quantity;
            const discountedPrice = totalPrice * (1 - discount / 100);

            ledgerArray[idx] = {
                ...ledgerArray[idx],
                product: productName,
                quantity,
                discount,
                amount: discountedPrice,
                customer,
                paymentMethod,
                momoId: paymentMethod === 'momo' ? momoId : null,
                date: new Date(date).toISOString()
            };

            saveData();
            updateAll();
            editModal.classList.add('hidden');
            editForm.reset();
            currentEditId = null;
            currentEditLedger = null;
            alert("Transaction updated successfully.");
        });

        // Initialize UI
        updateAll();
        toggleMomoField();

    </script>

</body>

</html>